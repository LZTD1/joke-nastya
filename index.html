<!DOCTYPE html>
<html lang="ru">
<head>
     <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–õ–æ–≤–µ—Ü –ù–∞—Å—Ç—è</title>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="–ù–∞—Å—Ç—è" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #4CAF50;
            overflow: hidden;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%; 
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #4CAF50;
        }
        
        #gameCanvas {
            display: block;
            background-color: #4CAF50;
            width: 100%;
            height: 100%;
        }
        
        #gameUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .ui-panel {
            background: rgba(0,0,0,0.4);
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-bottom: 10px; 
        }
        
        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 18px; 
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        #lives {
            position: absolute;
            top: 45px; 
            left: 10px;
            color: white;
            font-size: 16px; 
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
         #lives .heart, #lives .empty-heart {
            font-size: 16px;
        }
        #lives div[style*="font-size: 12px"] { 
            font-size: 10px !important;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 12px; 
            text-align: right;
            background: rgba(0,0,0,0.5); 
            padding: 8px;
            border-radius: 5px;
            pointer-events: auto;
            display: none; /* –°–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã JS –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */
        }
        
        #sizeControls {
            margin-top: 5px;
        }
        
        .size-control {
            margin: 3px 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
        }
        
        .size-control input {
            width: 45px; 
            padding: 1px 3px;
            font-size: 10px;
        }
        
        .size-control label {
            min-width: auto; 
            font-size: 10px;
            text-align: right;
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px; 
            font-weight: bold;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 15px;
            display: none;
            z-index: 20;
            width: 80%;
        }
         #gameOver div[style*="font-size: 24px"] { 
            font-size: 18px !important;
            margin: 10px 0 !important;
        }
        #gameOver div[style*="font-size: 18px"] { 
            font-size: 14px !important;
        }
        
        #levelProgress {
            position: absolute;
            top: 5px; 
            left: 50%;
            transform: translateX(-50%);
            width: 60%; 
            min-width: 150px; 
            color: white;
            text-align: center;
            font-size: 12px; 
        }
        
        .progress-bar {
            width: 100%;
            height: 15px; 
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 3px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #81C784);
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        #slowdownInfo {
            position: absolute;
            top: 85px; 
            left: 10px;
            color: #FFEB3B; 
            font-size: 12px; 
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
            display: none;
            padding: 5px;
        }

        #buffMessage {
            position: absolute;
            top: 40%; 
            left: 50%;
            transform: translate(-50%, -50%);
            color: #81C784; 
            font-size: 20px; 
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            background: rgba(0,0,0,0.65);
            padding: 10px 15px;
            border-radius: 10px;
            display: none;
            z-index: 20; 
        }

        #mobileControls {
			display: none;
            position: fixed; 
            bottom: 15px;    
            left: 50%;
            transform: translateX(-50%);
            display: none; /* –°–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã JS –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            z-index: 15; 
            gap: 30px; 
        }

        .mobile-button {
            width: 65px; 
            height: 65px;
            background-color: rgba(0, 0, 0, 0.5); 
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.7); 
            border-radius: 50%;
            font-size: 28px; 
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
        }

        .mobile-button:active {
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(0.95); 
        }
        
        #muteButton {
            position: fixed;
            top: 10px;
            right: 10px; /* –ë—É–¥–µ—Ç —Å–¥–≤–∏–Ω—É—Ç –µ—Å–ª–∏ #controls –≤–∏–¥–∏–º—ã */
            width: 40px;
            height: 40px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: 1px solid white;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 25; /* –í—ã—à–µ –≤—Å–µ–≥–æ */
            pointer-events: auto; /* –ß—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –Ω–∞–∂–∞—Ç—å */
        }


        @media (min-width: 769px) {
            #score {
                font-size: 24px;
                top: 20px;
                left: 20px;
            }
            #lives {
                font-size: 20px;
                top: 75px;
                left: 20px;
            }
            #lives .heart, #lives .empty-heart {
                font-size: 18px;
            }
            #lives div[style*="font-size: 10px"] { 
                font-size: 12px !important;
            }
            /* #controls - –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω JS */
            #controls { 
                font-size: 14px;
                padding: 10px;
                top: 20px;
                right: 20px;
            }

            #sizeControls { margin-top: 10px; }
            .size-control { margin: 5px 0; gap: 10px; }
            .size-control input { width: 60px; padding: 2px 5px; font-size: 12px;}
            .size-control label { min-width: 80px; font-size: 12px;}

            #gameOver { font-size: 32px; padding: 30px; }
             #gameOver div[style*="font-size: 18px"] { font-size: 24px !important; margin: 15px 0 !important;}
             #gameOver div[style*="font-size: 14px"] { font-size: 18px !important;}


            #levelProgress {
                width: 300px;
                font-size: 14px; 
                top: 10px;
            }
            .progress-bar { height: 20px; margin-top: 5px; }
            #slowdownInfo {
                font-size: 16px;
                top: 160px;
                left: 20px;
            }
            #buffMessage { font-size: 28px; padding: 15px 25px;}

            #muteButton { /* –ü–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∑–≤—É–∫–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
                top: 20px;
                right: 190px; /* –ü—Ä–∞–≤–µ–µ –±–ª–æ–∫–∞ #controls */
            }
            /* –ï—Å–ª–∏ #controls –æ—á–µ–Ω—å —à–∏—Ä–æ–∫–∏–π, –º–æ–∂–Ω–æ —Å–¥–≤–∏–Ω—É—Ç—å –µ—â–µ –ª–µ–≤–µ–µ */
            /* –ï—Å–ª–∏ #controls —Å–∫—Ä—ã—Ç, —Ç–æ #muteButton –±—É–¥–µ—Ç —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É */
        }
        @media (max-width: 768px) {
             #muteButton { /* –ü–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∑–≤—É–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
                top: 10px;
                right: 10px;
            }
        }

        @media (max-width: 360px) {
            .mobile-button {
                width: 55px;
                height: 55px;
                font-size: 24px;
            }
            #mobileControls {
			    display: visibility;
                gap: 20px;
                bottom: 10px;
            }
            #muteButton {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }
        }

    </style>
</head>
<body>
    <audio id="backgroundMusic" loop>
        <source src="music.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <button id="muteButton">üîä</button> <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–∫–ª/–≤—ã–∫–ª –∑–≤—É–∫–∞ -->

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="gameUI">
            <div id="score" class="ui-panel">–°—á–µ—Ç: 0</div>
            <div id="lives" class="ui-panel">
                <span id="heartsDisplay"></span>
                <div style="font-size: 12px; margin-top: 5px;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="regenTimer">60</span>—Å</div>
            </div>
            <div id="levelProgress" class="ui-panel">
                <div>–£—Ä–æ–≤–µ–Ω—å <span id="level">1</span> - –ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
             <div id="slowdownInfo" class="ui-panel">–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ: 20.0—Å</div>
             <div id="buffMessage"></div>

            <div id="controls">
                <div>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ‚Üê ‚Üí / A D</div>
                <div>–õ–æ–≤–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã, –∏–∑–±–µ–≥–∞–π—Ç–µ –≤—Ä–∞–≥–æ–≤!</div>
                <div id="sizeControls">
                    <div class="size-control">
                        <label>–ò–≥—Ä–æ–∫:</label>
                        <input type="number" id="playerSizeInput" value="200" min="20" max="400">
                    </div>
                    <div class="size-control">
                        <label>–ü—Ä–µ–¥–º–µ—Ç—ã:</label>
                        <input type="number" id="itemSizeInput" value="100" min="10" max="150">
                    </div>
                    <div class="size-control">
                        <label>–í—Ä–∞–≥–∏:</label>
                        <input type="number" id="enemySizeInput" value="100" min="10" max="150">
                    </div>
                </div>
            </div>
            <div id="gameOver">
                <div>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</div>
                <div style="font-size: 24px; margin: 15px 0;">–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: <span id="finalScore">0</span></div>
                <div style="font-size: 18px;">–ù–∞–∂–º–∏—Ç–µ R –∏–ª–∏ —Ç–∞–ø–Ω–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞</div>
            </div>
        </div>
        <div id="mobileControls">
            <button id="moveLeftButton" class="mobile-button">‚óÄ</button>
            <button id="moveRightButton" class="mobile-button">‚ñ∂</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('heartsDisplay');
        const gameOverElement = document.getElementById('gameOver');
        const finalScoreElement = document.getElementById('finalScore');
        const regenTimerElement = document.getElementById('regenTimer');
        const levelElement = document.getElementById('level');
        const progressFillElement = document.getElementById('progressFill');
        const slowdownInfoElement = document.getElementById('slowdownInfo');
        const buffMessageElement = document.getElementById('buffMessage');
        const controlsElement = document.getElementById('controls'); 
        const mobileControlsElement = document.getElementById('mobileControls');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const muteButton = document.getElementById('muteButton');


        const playerSizeInput = document.getElementById('playerSizeInput');
        const itemSizeInput = document.getElementById('itemSizeInput');
        const enemySizeInput = document.getElementById('enemySizeInput');

        function setCanvasSize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        setCanvasSize(); 

        let score = 0;
        let lives = 5;
        let maxLives = 5;
        let gameRunning = true;
        let animationId;
        let level = 1;
        let gameSpeed = 1.0; 
        let regenTimer = 60;
        let lastRegenTime = Date.now();

        const DEBUFF_DURATION = 20000; 
        let playerOriginalSpeed = 8; 
        let isPlayerSlowed = false;
        let slowdownEndTime = 0;
        let buffMessageTimeout = null;
        let musicPlaying = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º—É–∑—ã–∫–∏


        let desktopPlayerSize = 200;
        let desktopItemSize = 100;
        let desktopEnemySize = 100;
        
        let mobilePlayerSize = 90;  
        let mobileItemSize = 45;    
        let mobileEnemySize = 45;   
        let mobileDebafBafSize = 50; 

        let currentPlayerSize = desktopPlayerSize;
        let currentItemSize = desktopItemSize;
        let currentEnemySize = desktopEnemySize;
        let currentDebafBafSize = 70; 


        const background = new Image();
        background.src = 'bg.png'; 
        background.onerror = function() { console.log('–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); };

        const player = {
            x: canvas.width / 2,
            y: canvas.height - 120, 
            baseWidth: 398, baseHeight: 780, // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–´–ï –ü–†–û–ü–û–†–¶–ò–ò GG.PNG
            speed: 8,
            img: new Image()
        };
        playerOriginalSpeed = player.speed;

        function updatePlayerPosition() {
            const playerSize = getPlayerSize();
            player.y = canvas.height - playerSize.height - Math.max(10, canvas.height * 0.02); 
        }

        function getPlayerSize() {
            let size = currentPlayerSize;
            if (controlsElement.style.display !== 'none' && playerSizeInput.value) { 
                size = parseInt(playerSizeInput.value) || currentPlayerSize;
            }
            return { width: size, height: Math.round(size * (player.baseHeight/player.baseWidth)) };
        }

        const items = [];
        const enemies = [];
        const debafs = []; 
        const bafs = [];   

        const itemTemplate = {
            baseWidth: 292, baseHeight: 323, // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–´–ï –ü–†–û–ü–û–†–¶–ò–ò ITEM.PNG
            speed: 3, img: new Image()
        };
        const enemyTemplate = {
            baseWidth: 386, baseHeight: 379, // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–´–ï –ü–†–û–ü–û–†–¶–ò–ò ENEMY.PNG
            speed: 2.5, img: new Image()
        };
        const debafTemplate = { 
            baseWidth: 162, baseHeight: 163, // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–´–ï –ü–†–û–ü–û–†–¶–ò–ò DEBAF.PNG
            speed: 2.2, img: new Image()
        };
        const bafTemplate = { 
            baseWidth: 139, baseHeight: 154,  // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–´–ï –ü–†–û–ü–û–†–¶–ò–ò BAF.PNG
            speed: 2.8, img: new Image()
        };

        function getItemSize() {
            let size = currentItemSize;
             if (controlsElement.style.display !== 'none' && itemSizeInput.value) {
                size = parseInt(itemSizeInput.value) || currentItemSize;
            }
            return { width: size, height: Math.round(size * (itemTemplate.baseHeight/itemTemplate.baseWidth)) };
        }
        function getEnemySize() {
            let size = currentEnemySize;
             if (controlsElement.style.display !== 'none' && enemySizeInput.value) {
                size = parseInt(enemySizeInput.value) || currentEnemySize;
            }
            return { width: size, height: Math.round(size * (enemyTemplate.baseHeight/enemyTemplate.baseWidth)) };
        }
        
        function getDebafSize() {
            return { width: currentDebafBafSize, height: Math.round(currentDebafBafSize * (debafTemplate.baseHeight/debafTemplate.baseWidth)) };
        }
        function getBafSize() {
             return { width: currentDebafBafSize, height: Math.round(currentDebafBafSize * (bafTemplate.baseHeight/bafTemplate.baseWidth)) };
        }

        player.img.src = 'gg.png'; 
        itemTemplate.img.src = 'item.png'; 
        enemyTemplate.img.src = 'enemy.png'; 
        debafTemplate.img.src = 'debaf.png'; 
        bafTemplate.img.src = 'baf.png'; 

        [player.img, itemTemplate.img, enemyTemplate.img, debafTemplate.img, bafTemplate.img].forEach(img => {
            img.onerror = function() { console.log(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${this.src.substring(this.src.lastIndexOf('/')+1)} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`); };
        });

        const keys = {};
        let moveLeftActive = false;
        let moveRightActive = false;

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            keys[key] = true; 
            if (key === 'r' && !gameRunning) restartGame();
            tryToPlayMusic(); // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º—É–∑—ã–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
        });
        document.addEventListener('keyup', (e) => { 
            keys[e.key.toLowerCase()] = false; 
        });
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º—É–∑—ã–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ç–∞–ø–µ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
        document.body.addEventListener('touchstart', tryToPlayMusic, { once: true });


        function createItem() {
            const size = getItemSize();
            items.push({
                x: Math.random() * (canvas.width - size.width), y: -size.height - Math.random() * 50, 
                width: size.width, height: size.height,
                speed: (2 + Math.random() * 1.5) * gameSpeed, 
                img: itemTemplate.img, type: 'item'
            });
        }
        function createEnemy() {
            const size = getEnemySize();
            enemies.push({
                x: Math.random() * (canvas.width - size.width), y: -size.height - Math.random() * 50,
                width: size.width, height: size.height,
                speed: (1.5 + Math.random() * 1) * gameSpeed, 
                img: enemyTemplate.img, type: 'enemy'
            });
        }
        function createDebaf() {
            const size = getDebafSize();
            debafs.push({
                x: Math.random() * (canvas.width - size.width), y: -size.height - Math.random() * 50,
                width: size.width, height: size.height,
                speed: (debafTemplate.speed + Math.random() * 0.5) * gameSpeed,
                img: debafTemplate.img, type: 'debaf'
            });
        }
        function createBaf() {
            const size = getBafSize();
            bafs.push({
                x: Math.random() * (canvas.width - size.width), y: -size.height - Math.random() * 50,
                width: size.width, height: size.height,
                speed: (bafTemplate.speed + Math.random() * 0.5) * gameSpeed,
                img: bafTemplate.img, type: 'baf'
            });
        }

        function updateLevel() {
            const newLevel = Math.floor(score / 100) + 1;
            if (newLevel !== level) {
                level = newLevel;
                gameSpeed = 0.8 + (level - 1) * 0.1; // –ë–∞–∑–æ–≤–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∏–≥—Ä—ã
                levelElement.textContent = level;
            }
            const progressInLevel = (score % 100) / 100;
            progressFillElement.style.width = (progressInLevel * 100) + '%';
        }

        function getSpawnRates() {
            const baseItemRate = 0.012; 
            const baseEnemyRate = 0.0030; // –°–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∞–µ–º –±–∞–∑–æ–≤—ã–π —à–∞–Ω—Å –≤—Ä–∞–≥–∞
            const baseDebafRate = 0.0004; // –°–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∞–µ–º –±–∞–∑–æ–≤—ã–π —à–∞–Ω—Å –¥–µ–±–∞—Ñ–∞
            const baseBafRate = 0.0018;   

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å —Ä–æ—Å—Ç–∞ –¥–ª—è –≤—Ä–∞–≥–æ–≤ –∏ –¥–µ–±–∞—Ñ–æ–≤
            // –ß–µ–º –≤—ã—à–µ —É—Ä–æ–≤–µ–Ω—å, —Ç–µ–º –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–µ–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∏—Ö —à–∞–Ω—Å
            const enemyGrowthFactor = 0.0008 * level; // –ë—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç–µ—Ç —Å —É—Ä–æ–≤–Ω–µ–º
            const debafGrowthFactor = 0.0002 * level; // –ë—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç–µ—Ç —Å —É—Ä–æ–≤–Ω–µ–º

            return {
                itemRate: baseItemRate + (level - 1) * 0.004,
                enemyRate: Math.min(baseEnemyRate + enemyGrowthFactor, 0.06), // –ú–∞–∫—Å. —à–∞–Ω—Å 6%
                debafRate: Math.min(baseDebafRate + debafGrowthFactor, 0.015), // –ú–∞–∫—Å. —à–∞–Ω—Å 1.5%
                bafRate: Math.min(baseBafRate + (level - 1) * 0.0009, 0.018)   
            };
        }
        
        function showTemporaryMessage(element, message, duration) {
            element.textContent = message;
            element.style.display = 'block';
            if (element === buffMessageElement && buffMessageTimeout) {
                clearTimeout(buffMessageTimeout);
            }
            buffMessageTimeout = setTimeout(() => {
                element.style.display = 'none';
            }, duration);
        }

        function updateLives() {
            const now = Date.now();
            const timePassed = (now - lastRegenTime) / 1000;
            if (lives < maxLives) {
                regenTimer -= timePassed;
                if (regenTimer <= 0) {
                    lives = Math.min(maxLives, lives + 1);
                    regenTimer = 60;
                    updateLivesDisplay();
                }
            } else {
                regenTimer = 60;
            }
            regenTimerElement.textContent = Math.ceil(regenTimer);
            lastRegenTime = now;
        }

        function updateLivesDisplay() {
            let heartsHtml = '';
            for (let i = 0; i < maxLives; i++) {
                heartsHtml += (i < lives) ? '<span class="heart">‚ô•</span>' : '<span class="empty-heart">‚ô°</span>';
            }
            livesElement.innerHTML = heartsHtml;
        }

        function updatePlayer() {
            const playerSize = getPlayerSize();
            updatePlayerPosition(); 

            const movingLeft = keys['arrowleft'] || keys['a'] || moveLeftActive;
            const movingRight = keys['arrowright'] || keys['d'] || moveRightActive;

            if (movingLeft && player.x > 0) {
                player.x -= player.speed;
            }
            if (movingRight && player.x < canvas.width - playerSize.width) {
                 player.x += player.speed;
            }
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - playerSize.width) player.x = canvas.width - playerSize.width;

            if (isPlayerSlowed) {
                const remainingSlowdown = Math.max(0, (slowdownEndTime - Date.now()) / 1000);
                slowdownInfoElement.textContent = `–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ: ${remainingSlowdown.toFixed(1)}—Å`;
                if (remainingSlowdown <= 0) {
                    isPlayerSlowed = false;
                    player.speed = playerOriginalSpeed;
                    slowdownInfoElement.style.display = 'none';
                }
            }
        }

        function updateGameObjects(arr, onCollect, onMiss) {
            const playerSize = getPlayerSize(); 
            for (let i = arr.length - 1; i >= 0; i--) {
                const obj = arr[i];
                obj.y += obj.speed;
                if (obj.x + obj.width > player.x && 
                    obj.x < player.x + playerSize.width && 
                    obj.y + obj.height > player.y && 
                    obj.y < player.y + playerSize.height) { 
                    onCollect(obj, i); 
                    continue; 
                }
                if (obj.y > canvas.height + 50) { 
                    if (onMiss) onMiss(obj, i); 
                    arr.splice(i, 1);
                }
            }
        }

        function updateItems() {
            updateGameObjects(items, (item, i) => {
                items.splice(i, 1);
                score += 10;
                scoreElement.textContent = `–°—á–µ—Ç: ${score}`;
                updateLevel();
            });
        }
        function updateEnemies() {
            updateGameObjects(enemies, (enemy, i) => {
                enemies.splice(i, 1);
                lives--;
                updateLivesDisplay();
                if (lives <= 0) endGame();
            });
        }
        function updateDebafs() {
            updateGameObjects(debafs, (debaf, i) => {
                debafs.splice(i, 1);
                if (!isPlayerSlowed) { 
                    isPlayerSlowed = true;
                    player.speed = playerOriginalSpeed / 2; 
                    slowdownEndTime = Date.now() + DEBUFF_DURATION;
                    slowdownInfoElement.style.display = 'block';
                    showTemporaryMessage(buffMessageElement, "–ó–ê–ú–ï–î–õ–ï–ù–ò–ï!", 2000);
                } else { 
                     slowdownEndTime = Date.now() + DEBUFF_DURATION; 
                     showTemporaryMessage(buffMessageElement, "–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–ª–µ–Ω–æ!", 1500);
                }
            });
        }
        function updateBafs() {
            updateGameObjects(bafs, (baf, i) => {
                bafs.splice(i, 1);
                if (lives < maxLives) {
                    lives++;
                    updateLivesDisplay();
                    showTemporaryMessage(buffMessageElement, "+1 –ñ–ò–ó–ù–¨!", 2000);
                } else {
                    showTemporaryMessage(buffMessageElement, "–ó–¥–æ—Ä–æ–≤—å–µ –ø–æ–ª–Ω–æ–µ!", 1500);
                }
            });
        }

        function drawBackground() {
            if (background.complete && background.naturalWidth > 0) {
                const ar = background.naturalWidth / background.naturalHeight;
                let drawWidth = canvas.width;
                let drawHeight = canvas.width / ar;
                if (drawHeight < canvas.height) { 
                    drawHeight = canvas.height;
                    drawWidth = canvas.height * ar;
                }
                const offsetX = (canvas.width - drawWidth) / 2;
                const offsetY = (canvas.height - drawHeight) / 2;
                ctx.drawImage(background, offsetX, offsetY, drawWidth, drawHeight);
            } else {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#4CAF50');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        function drawPlayer() {
            const playerSize = getPlayerSize();
            if (player.img.complete && player.img.naturalWidth > 0) {
                ctx.drawImage(player.img, player.x, player.y, playerSize.width, playerSize.height);
            } else { 
                ctx.fillStyle = '#FF6B6B';
                ctx.fillRect(player.x, player.y, playerSize.width, playerSize.height);
            }
        }

        function drawArray(arr, defaultColor = '#CCCCCC', shape = 'rect') {
            arr.forEach(obj => {
                if (obj.img.complete && obj.img.naturalWidth > 0) {
                    ctx.drawImage(obj.img, obj.x, obj.y, obj.width, obj.height);
                } else { 
                    ctx.fillStyle = defaultColor;
                    if (shape === 'rect') {
                         ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
                    } else if (shape === 'diamond') {
                        ctx.beginPath();
                        ctx.moveTo(obj.x + obj.width/2, obj.y);
                        ctx.lineTo(obj.x + obj.width, obj.y + obj.height/2);
                        ctx.lineTo(obj.x + obj.width/2, obj.y + obj.height);
                        ctx.lineTo(obj.x, obj.y + obj.height/2);
                        ctx.closePath();
                        ctx.fill();
                    } else if (shape === 'triangle') {
                        ctx.beginPath();
                        ctx.moveTo(obj.x + obj.width/2, obj.y);
                        ctx.lineTo(obj.x, obj.y + obj.height);
                        ctx.lineTo(obj.x + obj.width, obj.y + obj.height);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            });
        }

        function gameLoop() {
            if (!gameRunning) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();

            updatePlayer(); 
            updateItems();
            updateEnemies();
            updateDebafs();
            updateBafs();
            updateLives();

            drawPlayer();
            drawArray(items, '#FFD700', 'diamond');
            drawArray(enemies, '#FF4757', 'triangle');
            drawArray(debafs, '#BCA0DC', 'rect'); 
            drawArray(bafs, '#90EE90', 'rect');   

            const spawnRates = getSpawnRates();
            if (items.length < 10 && Math.random() < spawnRates.itemRate) createItem(); 
            if (enemies.length < 7 && Math.random() < spawnRates.enemyRate) createEnemy(); // –£–≤–µ–ª–∏—á–∏–ª –Ω–µ–º–Ω–æ–≥–æ –ª–∏–º–∏—Ç –≤—Ä–∞–≥–æ–≤
            if (debafs.length < 2 && Math.random() < spawnRates.debafRate) createDebaf();
            if (bafs.length < 2 && Math.random() < spawnRates.bafRate) createBaf();

            animationId = requestAnimationFrame(gameLoop);
        }

        function restartGame() {
            score = 0;
            lives = 5;
            level = 1;
            gameSpeed = 0.8; 
            regenTimer = 60;
            lastRegenTime = Date.now();
            
            isPlayerSlowed = false;
            player.speed = playerOriginalSpeed; 
            slowdownInfoElement.style.display = 'none';
            if (buffMessageTimeout) clearTimeout(buffMessageTimeout);
            buffMessageElement.style.display = 'none';

            scoreElement.textContent = `–°—á–µ—Ç: ${score}`;
            levelElement.textContent = level;
            progressFillElement.style.width = '0%';
            updateLivesDisplay();
            
            items.length = 0; enemies.length = 0; debafs.length = 0; bafs.length = 0;
            
            updatePlayerPosition(); 
            player.x = canvas.width / 2 - getPlayerSize().width / 2; 

            gameRunning = true;
            gameOverElement.style.display = 'none';
            if (animationId) cancelAnimationFrame(animationId); 
            tryToPlayMusic(); // –ü–æ–ø—ã—Ç–∫–∞ –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
            gameLoop();
        }

        function endGame() {
            gameRunning = false;
            finalScoreElement.textContent = score;
            gameOverElement.style.display = 'block';
            cancelAnimationFrame(animationId);
            // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º—É–∑—ã–∫—É –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∏–≥—Ä—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            // backgroundMusic.pause();
            // musicPlaying = false;
            // muteButton.textContent = 'üîá';
        }

        const moveLeftButton = document.getElementById('moveLeftButton');
        const moveRightButton = document.getElementById('moveRightButton');

        function isTouchDevice() {
            return (('ontouchstart' in window) ||
                   (navigator.maxTouchPoints > 0) ||
                   (navigator.msMaxTouchPoints > 0));
        }

        function setupControlsBasedOnDevice() {
            const touchDevice = isTouchDevice();
            const narrowWindow = window.innerWidth <= 768;

            if (narrowWindow) {
                mobileControlsElement.style.display = 'flex';
                controlsElement.style.display = 'none'; 

                currentPlayerSize = mobilePlayerSize;
                currentItemSize = mobileItemSize;
                currentEnemySize = mobileEnemySize;
                currentDebafBafSize = mobileDebafBafSize;
            } else { // Desktop
                 mobileControlsElement.style.display = 'none';
                 controlsElement.style.display = 'block'; 
                 currentPlayerSize = desktopPlayerSize;
                 currentItemSize = desktopItemSize;
                 currentEnemySize = desktopEnemySize;
                 currentDebafBafSize = 70; 
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∏–Ω–ø—É—Ç–∞—Ö, –µ—Å–ª–∏ –æ–Ω–∏ –≤–∏–¥–∏–º—ã
            playerSizeInput.value = currentPlayerSize;
            itemSizeInput.value = currentItemSize;
            enemySizeInput.value = currentEnemySize;
        }
        
        moveLeftButton.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            moveLeftActive = true;
            tryToPlayMusic(); 
        }, { passive: false }); 
        moveLeftButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            moveLeftActive = false;
        }, { passive: false });

        moveRightButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            moveRightActive = true;
            tryToPlayMusic();
        }, { passive: false });
        moveRightButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            moveRightActive = false;
        }, { passive: false });

        gameOverElement.addEventListener('click', () => { 
             if (!gameRunning) restartGame();
        });
         gameOverElement.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!gameRunning) restartGame();
        }, { passive: false });

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—É–∑—ã–∫–æ–π ---
        function tryToPlayMusic() {
            if (!musicPlaying && backgroundMusic.paused) {
                backgroundMusic.volume = 0.3;
                const playPromise = backgroundMusic.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        musicPlaying = true;
                        muteButton.textContent = 'üîä';
                    }).catch(error => {
                        console.log("Autoplay LIGR prevented. User interaction needed.", error);
                        // –ú—É–∑—ã–∫–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—É–¥–µ—Ç –Ω–∞–∂–∞—Ç—å mute/unmute
                        musicPlaying = false;
                        muteButton.textContent = 'üîá';
                    });
                }
            }
        }

        muteButton.addEventListener('click', () => {
            if (backgroundMusic.paused) {
                backgroundMusic.volume = 0.3; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
                backgroundMusic.play().then(() => {
                    musicPlaying = true;
                    muteButton.textContent = 'üîä';
                }).catch(error => console.log("Error playing music on click:", error));
            } else {
                backgroundMusic.pause();
                musicPlaying = false;
                muteButton.textContent = 'üîá';
            }
        });
        
        // –ù–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –º—É–∑—ã–∫–∞ –µ—â–µ –Ω–µ –∏–≥—Ä–∞–µ—Ç
        backgroundMusic.volume = 0.3;


        window.addEventListener('resize', () => {
            setCanvasSize();
            setupControlsBasedOnDevice(); 
            updatePlayerPosition(); 
            const pSize = getPlayerSize();
            if (player.x > canvas.width - pSize.width) player.x = canvas.width - pSize.width;
            if (player.x < 0) player.x = 0;
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        setupControlsBasedOnDevice(); 
        updateLivesDisplay();
        updatePlayerPosition(); 
        player.x = canvas.width / 2 - getPlayerSize().width / 2; 
        // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º gameLoop —Å—Ä–∞–∑—É, –¥–∞–¥–∏–º —à–∞–Ω—Å –º—É–∑—ã–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å
        // gameLoop(); // –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–ª–∏ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–æ –ø–æ—Å–ª–µ tryToPlayMusic
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º—É–∑—ã–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–æ–º)
        window.addEventListener('load', () => {
            // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º tryToPlayMusic –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ
            // –õ—É—á—à–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            gameLoop(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ
        });


    </script>
</body>
</html>
