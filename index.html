<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–æ–≤–µ—Ü –ù–∞—Å—Ç—è: Final Balance</title>
    <style>
        :root {
            --primary: #4CAF50;
            --accent: #FFD700;
            --danger: #FF5252;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #222; font-family: var(--font-main);
            touch-action: none; user-select: none;
        }

        #gameContainer {
            position: relative; width: 100vw; height: 100vh;
            background: #333;
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* UI HUD */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; z-index: 10;
        }

        .hud-bar {
            display: flex; justify-content: center; gap: 15px; padding: 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.85), transparent);
            color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .stat-box { display: flex; flex-direction: column; align-items: center; min-width: 70px; }
        .stat-label { font-size: 10px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 20px; font-weight: bold; color: var(--accent); }
        
        .bar-container {
            width: 100px; height: 8px; background: rgba(255,255,255,0.2);
            border-radius: 4px; margin-top: 5px; overflow: hidden; position: relative;
        }
        .bar-fill { height: 100%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s; }
        .hp-fill { background: var(--primary); } 
        .lvl-fill { background: var(--accent); }

        /* –ö–í–ï–°–¢–´ */
        #questBox {
            position: absolute; top: 80px; right: 10px;
            width: 200px; padding: 10px;
            background: rgba(0, 0, 0, 0.6); border-left: 4px solid var(--accent);
            border-radius: 0 8px 8px 0; color: white; font-size: 14px;
            transition: transform 0.3s; backdrop-filter: blur(4px);
        }
        #questBox.hidden { transform: translateX(250px); }
        .quest-title { font-size: 10px; text-transform: uppercase; color: #aaa; margin-bottom: 4px; }
        .quest-text { font-weight: bold; margin-bottom: 5px; }
        .quest-progress { height: 4px; background: #555; width: 100%; border-radius: 2px; }
        .quest-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* –ë–û–°–° */
        #bossContainer {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            width: 60%; max-width: 400px; display: none; flex-direction: column; align-items: center;
        }
        .boss-label { color: var(--danger); font-weight: bold; font-size: 18px; text-shadow: 0 0 10px black; margin-bottom: 5px; }
        .boss-hp-bg { width: 100%; height: 15px; background: rgba(0,0,0,0.7); border: 2px solid white; border-radius: 10px; overflow: hidden; }
        .boss-hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #D32F2F, #FF5252); transition: width 0.2s; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; pointer-events: auto; transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none !important; }
        
        h1 { color: white; font-size: 3.5rem; margin: 0 0 10px 0; text-transform: uppercase; text-align: center; }
        .hardcore-title { color: var(--danger) !important; text-shadow: 0 0 20px var(--danger); }
        p { color: #ddd; max-width: 400px; text-align: center; line-height: 1.5; margin-bottom: 10px;}
        
        .btn {
            margin-top: 10px; padding: 15px 40px; font-size: 20px;
            background: var(--primary); color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            text-transform: uppercase; font-weight: bold;
        }
        
        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
        .mode-switch {
            margin: 15px 0; display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 30px;
        }
        .switch-label { color: white; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px;
            left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--danger); }
        input:checked + .slider:before { transform: translateX(26px); }
        .hardcore-text { color: var(--danger); font-weight: bold; font-size: 12px; margin-top: 5px; display: none; }
        input:checked ~ .hardcore-text { display: block; }

        #buffMessage {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 32px; font-weight: bold; color: #fff; text-shadow: 0 0 10px black;
            opacity: 0; transition: opacity 0.3s; text-align: center; width: 100%;
            pointer-events: none;
        }

        #muteButton {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3);
            color: white; width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; z-index: 110; display: flex; justify-content: center; align-items: center;
            font-size: 20px; pointer-events: auto;
        }

        .touch-zone { position: absolute; top: 0; height: 100%; width: 50%; z-index: 50; pointer-events: auto; }
        #leftZone { left: 0; }
        #rightZone { right: 0; }
    </style>
</head>
<body>

<audio id="bgMusic" loop>
    <source src="music.mp3" type="audio/mpeg">
</audio>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <button id="muteButton">üîá</button>

    <!-- –ú–µ–Ω—é –°–¢–ê–†–¢ -->
    <div id="startScreen" class="screen-overlay">
        <h1 id="gameTitle">–ù–∞—Å—Ç—è</h1>
        <p>–õ–æ–≤–∏ –ø—Ä–µ–¥–º–µ—Ç—ã, –∏–∑–±–µ–≥–∞–π –≤—Ä–∞–≥–æ–≤.<br>–í—ã–ø–æ–ª–Ω—è–π —Å–ª—É—á–∞–π–Ω—ã–µ –∫–≤–µ—Å—Ç—ã!</p>
        
        <div class="mode-switch">
            <span class="switch-label">Normal</span>
            <label class="switch">
                <input type="checkbox" id="hardcoreToggle">
                <span class="slider"></span>
            </label>
            <span class="switch-label" style="color: var(--danger)">HARDCORE</span>
        </div>
        <div class="hardcore-text">1 –ñ–∏–∑–Ω—å ‚Ä¢ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ ‚Ä¢ –í—Ä–∞–≥–∏ –∑–ª–µ–µ</div>
        
        <button class="btn" id="startBtn">–ò–ì–†–ê–¢–¨</button>
    </div>

    <!-- –ú–µ–Ω—é GAME OVER -->
    <div id="gameOverScreen" class="screen-overlay hidden">
        <h1>GAME OVER</h1>
        <h2>–°—á–µ—Ç: <span id="finalScore">0</span></h2>
        <p>–ü–æ–ø—Ä–æ–±—É–π —É–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</p>

        <div class="mode-switch">
            <span class="switch-label">Normal</span>
            <label class="switch">
                <input type="checkbox" id="hardcoreToggleGO">
                <span class="slider"></span>
            </label>
            <span class="switch-label" style="color: var(--danger)">HARDCORE</span>
        </div>
        <div class="hardcore-text">1 –ñ–∏–∑–Ω—å ‚Ä¢ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ ‚Ä¢ –í—Ä–∞–≥–∏ –∑–ª–µ–µ</div>

        <button class="btn" id="restartBtn">–ó–ê–ù–û–í–û</button>
    </div>

    <!-- HUD -->
    <div id="gameUI" class="ui-layer">
        <div class="hud-bar">
            <div class="stat-box">
                <span class="stat-label">–£—Ä–æ–≤–µ–Ω—å</span>
                <span class="stat-value" id="uiLevel">1</span>
                <div class="bar-container"><div class="bar-fill lvl-fill" id="uiLevelBar" style="width: 0%"></div></div>
            </div>
            <div class="stat-box">
                <span class="stat-label">–°—á–µ—Ç</span>
                <span class="stat-value" id="uiScore">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">–ñ–∏–∑–Ω–∏</span>
                <div class="bar-container"><div class="bar-fill hp-fill" id="uiHpBar" style="width: 100%"></div></div>
            </div>
        </div>

        <div id="questBox">
            <div class="quest-title">–¢–µ–∫—É—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
            <div class="quest-text" id="questDesc">...</div>
            <div class="quest-progress"><div class="quest-bar" id="questBar"></div></div>
        </div>

        <div id="bossContainer">
            <div class="boss-label">–ë–û–°–°</div>
            <div class="boss-hp-bg"><div class="boss-hp-fill" id="bossHpBar"></div></div>
        </div>

        <div id="buffMessage"></div>
    </div>

    <div id="leftZone" class="touch-zone"></div>
    <div id="rightZone" class="touch-zone"></div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    const CONFIG = {
        colors: { 
            primary: '#4CAF50', warning: '#FFC107', danger: '#FF5252', 
            item: '#FFD700', buff: '#64FFDA', debuff: '#B388FF', 
            tracker: '#7C4DFF', ghost: '#00E5FF' 
        },
        player: { desktopSize: 180, mobileSize: 100, ratio: 398/780 }
    };

    // --- –°–û–°–¢–û–Ø–ù–ò–ï ---
    const Game = {
        canvas: null, ctx: null, isRunning: false,
        width: 0, height: 0, score: 0, level: 1,
        lives: 5, maxLives: 5, isHardcore: false, gameSpeed: 1.0,
        spawnTimer: 0, spawnInterval: 60, 
        objects: [], particles: [], floatingTexts: [],
        player: { x: 0, y: 0, width: 0, height: 0, speed: 0, isSlowed: false, slowTimer: 0 },
        keys: { left: false, right: false },
        images: {}, bossMode: false, boss: null,
        quest: { active: false, type: '', target: 0, current: 0, reward: 0, desc: '' }
    };

    const imgSources = { player: 'gg.png', item: 'item.png', enemy: 'enemy.png', buff: 'baf.png', debuff: 'debaf.png', bg: 'bg.png' };

    // --- –§–£–ù–ö–¶–ò–ò ---
    function generateRandomQuest() {
        const types = ['collect_items', 'dodge_enemies', 'get_buff', 'score_points'];
        const type = types[Math.floor(Math.random() * types.length)];
        let target, reward, text, currentScoreStart = 0;

        switch(type) {
            case 'collect_items': target = Math.floor(Math.random() * 11) + 5; reward = target * 20; text = `–°–æ–±–µ—Ä–∏ ${target} –ø—Ä–µ–¥–º–µ—Ç–æ–≤`; break;
            case 'dodge_enemies': target = Math.floor(Math.random() * 8) + 3; reward = target * 30; text = `–ü—Ä–æ–ø—É—Å—Ç–∏ ${target} –≤—Ä–∞–≥–æ–≤`; break;
            case 'get_buff': target = Math.random() < 0.8 ? 1 : 2; reward = target * 200; text = `–ù–∞–π–¥–∏ ${target} –ë–∞—Ñ—Ñ(–∞)`; break;
            case 'score_points': target = Math.floor(Math.random() * 4) * 100 + 200; currentScoreStart = Game.score; reward = Math.floor(target * 0.5); text = `–ù–∞–±–µ—Ä–∏ ${target} –æ—á–∫–æ–≤`; break;
        }
        return { type: type, text: text, target: target, current: 0, reward: reward, currentScoreStart: currentScoreStart, active: true };
    }

    class GameObject {
        constructor(type) {
            this.type = type; this.subtype = 'normal'; this.opacity = 1;
            const isMobile = Game.width <= 768;
            const baseSize = isMobile ? 50 : 80;
            this.width = baseSize; this.height = baseSize;
            
            if (type === 'enemy' && !Game.bossMode) this.subtype = pickEnemyType(); 

            this.x = Math.random() * (Game.width - this.width);
            this.y = -this.height - 20;
            
            let levelCap = Math.min(Game.level, 30);
            let speedMult = Game.gameSpeed * (1 + (levelCap * 0.06));
            
            if (type === 'item') this.speed = (3 + Math.random()) * speedMult;
            else if (type === 'buff') this.speed = (5 + Math.random()) * speedMult;
            else if (type === 'debuff') this.speed = (3 + Math.random()) * speedMult;
            else if (type === 'enemy') {
                if (this.subtype === 'normal') this.speed = (4 + Math.random() * 2) * speedMult;
                if (this.subtype === 'tracker') this.speed = (3 + Math.random()) * speedMult; 
                if (this.subtype === 'ghost') this.speed = (5 + Math.random() * 2) * speedMult; 
            }
            if (type === 'projectile') { this.speed = 7 * Game.gameSpeed; this.width = 30; this.height = 30; }
        }
        update() {
            this.y += this.speed;
            if (this.type === 'enemy') {
                if (this.subtype === 'tracker') {
                    const centerPlayer = Game.player.x + Game.player.width/2;
                    const centerEnemy = this.x + this.width/2;
                    if (centerEnemy < centerPlayer - 10) this.x += 1.5 * Game.gameSpeed;
                    else if (centerEnemy > centerPlayer + 10) this.x -= 1.5 * Game.gameSpeed;
                }
                if (this.subtype === 'ghost') this.opacity = 0.4 + Math.abs(Math.sin(Date.now() / 200)) * 0.6;
            }
        }
        draw(ctx) {
            ctx.save(); ctx.globalAlpha = this.opacity;
            if (this.type === 'enemy') {
                let glowColor = CONFIG.colors.danger; let blurAmount = 15;
                if (this.subtype === 'tracker') { glowColor = CONFIG.colors.tracker; blurAmount = 20; } 
                else if (this.subtype === 'ghost') { glowColor = CONFIG.colors.ghost; blurAmount = 25; }
                ctx.shadowBlur = blurAmount; ctx.shadowColor = glowColor;
                if (!Game.images['enemy'].complete) ctx.fillStyle = glowColor;
            }
            if (this.type === 'projectile') {
                ctx.shadowBlur = 15; ctx.shadowColor = 'orange';
                ctx.fillStyle = '#FF5722'; ctx.beginPath(); 
                ctx.arc(this.x+this.width/2, this.y+this.height/2, this.width/2, 0, Math.PI*2); ctx.fill();
            } else if (Game.images[this.type] && Game.images[this.type].complete && Game.images[this.type].naturalWidth > 0) {
                ctx.drawImage(Game.images[this.type], this.x, this.y, this.width, this.height);
            } else { 
                ctx.fillStyle = CONFIG.colors[this.type] || '#FFF'; 
                ctx.fillRect(this.x, this.y, this.width, this.height); 
            }
            ctx.restore();
        }
    }

    function pickEnemyType() {
        const r = Math.random();
        if (Game.level < 3) return 'normal'; 
        if (Game.level < 5) return r < 0.3 ? 'tracker' : 'normal'; 
        if (r < 0.25) return 'tracker';
        if (r < 0.45) return 'ghost';
        return 'normal';
    }

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –°–ü–ê–í–ù–ï–† (–ë–ê–õ–ê–ù–°) ---
    function handleSpawning() {
        Game.spawnTimer--;
        
        if (Game.spawnTimer <= 0) {
            if (Game.bossMode) {
                // --- –õ–û–ì–ò–ö–ê –ë–û–°–°–ê ---
                // –¢–µ–ø–µ—Ä—å —Ö–∏–ª–∫–∏ –Ω–µ –ø–∞–¥–∞—é—Ç –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä. –°–ø–∞–≤–Ω –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä–æ–º.
                // –®–∞–Ω—Å —Ö–∏–ª–∫–∏ 15%, –ü—Ä–µ–¥–º–µ—Ç 85%
                if (Math.random() < 0.15) Game.objects.push(new GameObject('buff'));
                else Game.objects.push(new GameObject('item'));
                
                // –¢–∞–π–º–µ—Ä —Å–ø–∞–≤–Ω–∞ –Ω–∞ –±–æ—Å—Å–µ (–Ω–µ–º–Ω–æ–≥–æ —á–∞—â–µ, —á–µ–º –æ–±—ã—á–Ω–æ)
                Game.spawnTimer = 50; 
            } 
            else {
                // --- –û–ë–´–ß–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
                const r = Math.random();
                let buffChance = (Game.lives <= 2) ? 0.15 : 0.08; 
                
                // –£–í–ï–õ–ò–ß–ò–õ –®–ê–ù–° –ü–†–ï–î–ú–ï–¢–û–í (–±—ã–ª–æ 0.35, —Å—Ç–∞–ª–æ 0.45)
                let itemChance = 0.45; 
                let debuffChance = 0.05;
                
                if (r < buffChance) Game.objects.push(new GameObject('buff'));
                else if (r < buffChance + debuffChance) Game.objects.push(new GameObject('debuff'));
                else if (r < buffChance + debuffChance + itemChance) Game.objects.push(new GameObject('item')); 
                else Game.objects.push(new GameObject('enemy')); 

                const difficultyMod = Game.isHardcore ? 15 : 0;
                const levelMod = Math.min(30, Game.level * 3);
                Game.spawnInterval = Math.max(20, 65 - levelMod - difficultyMod);
                Game.spawnTimer = Game.spawnInterval + (Math.random() * 20);
            }
        }
    }

    class Boss {
        constructor() {
            this.width = Game.width <= 768 ? 150 : 250; this.height = this.width;
            this.x = Game.width/2 - this.width/2; this.y = 50;
            this.hp = 100; this.maxHp = 100; this.direction = 1;
            this.moveSpeed = 3; this.shootTimer = 0;
            this.img = Game.images['enemy'];
        }
        update() {
            this.x += this.moveSpeed * this.direction;
            if (this.x <= 0 || this.x+this.width>=Game.width) this.direction *= -1;
            this.shootTimer--;
            if (this.shootTimer <= 0) {
                const proj = new GameObject('projectile');
                proj.x = this.x + this.width/2 - 15; proj.y = this.y + this.height - 20;
                Game.objects.push(proj);
                this.shootTimer = Game.isHardcore ? 40 : 70;
            }
        }
        draw(ctx) {
            const floatY = Math.sin(Date.now()/500)*10;
            ctx.save(); ctx.shadowBlur=30; ctx.shadowColor=CONFIG.colors.danger;
            if(this.img.complete && this.img.naturalWidth > 0) ctx.drawImage(this.img, this.x, this.y+floatY, this.width, this.height);
            else { ctx.fillStyle = 'red'; ctx.fillRect(this.x, this.y+floatY, this.width, this.height); }
            ctx.restore();
        }
        takeDamage(amt) {
            this.hp -= amt; createExplosion(this.x+this.width/2, this.y+this.height/2, '#FFF');
            document.getElementById('bossHpBar').style.width = Math.max(0, (this.hp/this.maxHp)*100) + '%';
            if(this.hp<=0) {
                Game.score += 1000; Game.bossMode=false; Game.boss=null; Game.level++;
                document.getElementById('bossContainer').style.display='none';
                showBuffMessage("–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù!", "#FFD700"); startNewQuest();
            }
        }
    }

    function update() {
        if (Game.isHardcore) Game.gameSpeed += 0.00005;

        const isMobile = Game.width <= 768;
        let speed = (isMobile ? 6 : 10) * Game.gameSpeed;
        if (Game.player.isSlowed) { speed *= 0.5; Game.player.slowTimer--; if(Game.player.slowTimer<=0) Game.player.isSlowed=false; }
        if (Game.keys.left && Game.player.x > 0) Game.player.x -= speed;
        if (Game.keys.right && Game.player.x < Game.width - Game.player.width) Game.player.x += speed;

        if (Game.bossMode && Game.boss) Game.boss.update();

        for (let i = Game.objects.length - 1; i >= 0; i--) {
            let obj = Game.objects[i];
            obj.update();
            if (checkCollision(Game.player, obj)) {
                handleCollision(obj); Game.objects.splice(i, 1); continue;
            }
            if (obj.y > Game.height) {
                if (obj.type === 'enemy') updateQuestProgress('enemy_pass');
                Game.objects.splice(i, 1);
            }
        }

        Game.particles.forEach((p, i) => { p.update(); if(p.life<=0) Game.particles.splice(i,1); });
        Game.floatingTexts.forEach((t, i) => { t.update(); if(t.life<=0) Game.floatingTexts.splice(i,1); });

        handleSpawning(); 
        checkBossSpawn();
        updateUI();
    }

    function checkCollision(p, o) {
        return o.x < p.x + p.width && o.x + o.width > p.x && o.y < p.y + p.height && o.y + o.height > p.y;
    }

    function handleCollision(obj) {
        const cx = obj.x + obj.width/2; const cy = obj.y + obj.height/2;
        if (obj.type === 'item') {
            Game.score += 10; createExplosion(cx, cy, CONFIG.colors.item);
            Game.floatingTexts.push(new FloatingText(cx, cy, "+10", CONFIG.colors.item));
            updateQuestProgress('item'); checkLevelUp();
        } else if (obj.type === 'enemy' || obj.type === 'projectile') {
            Game.lives--; updateUI(); 
            createExplosion(cx, cy, CONFIG.colors.danger);
            Game.floatingTexts.push(new FloatingText(cx, cy, "-1 HP", CONFIG.colors.danger));
            navigator.vibrate?.(200);
            if (Game.lives <= 0) gameOver();
        } else if (obj.type === 'buff') {
            if (Game.bossMode) {
                Game.boss.takeDamage(15); createExplosion(cx, cy, CONFIG.colors.buff);
                Game.floatingTexts.push(new FloatingText(cx, cy, "–£–î–ê–†!", "#FFF"));
            } else {
                if (Game.lives < Game.maxLives) { Game.lives++; showBuffMessage("+1 –ñ–ò–ó–ù–¨", CONFIG.colors.buff); }
                else { Game.score += 50; showBuffMessage("–ë–û–ù–£–° –û–ß–ö–ò", CONFIG.colors.buff); }
                updateQuestProgress('buff');
            }
        } else if (obj.type === 'debuff') {
            Game.player.isSlowed = true; Game.player.slowTimer = 120;
            showBuffMessage("–ó–ê–ú–ï–î–õ–ï–ù–ò–ï!", CONFIG.colors.debuff);
        }
    }

    function updateUI() {
        document.getElementById('uiScore').textContent = Game.score;
        document.getElementById('uiLevel').textContent = Game.level;
        document.getElementById('uiLevelBar').style.width = (Game.score % 100) + '%';

        const hpBar = document.getElementById('uiHpBar');
        const hpPercent = Math.max(0, (Game.lives / Game.maxLives) * 100); 
        hpBar.style.width = hpPercent + '%';
        if (hpPercent > 50) hpBar.style.backgroundColor = CONFIG.colors.primary; 
        else if (hpPercent > 25) hpBar.style.backgroundColor = CONFIG.colors.warning; 
        else hpBar.style.backgroundColor = CONFIG.colors.danger; 
    }

    function checkBossSpawn() {
        if (Game.level % 5 === 0 && !Game.bossMode && Game.level > 0) {
            Game.bossMode = true; Game.boss = new Boss();
            document.getElementById('bossContainer').style.display = 'flex';
            document.getElementById('bossHpBar').style.width = '100%';
            showBuffMessage("–í–ù–ò–ú–ê–ù–ò–ï: –ë–û–°–°!", "#FF5252");
            Game.objects = Game.objects.filter(o => o.type !== 'enemy');
        }
    }

    function createExplosion(x, y, c) { for(let i=0;i<12;i++) Game.particles.push(new Particle(x, y, c)); }
    function showBuffMessage(t, c) {
        const el = document.getElementById('buffMessage'); el.textContent=t; el.style.color=c; el.style.opacity=1;
        setTimeout(()=>el.style.opacity=0, 2000);
    }

    class Particle {
        constructor(x,y,c) { this.x=x; this.y=y; this.c=c; this.s=Math.random()*5+2; this.vx=Math.random()*6-3; this.vy=Math.random()*6-3; this.l=1; }
        update() { this.x+=this.vx; this.y+=this.vy; this.l-=0.03; this.s*=0.9; }
        draw(ctx) { ctx.fillStyle=this.c; ctx.globalAlpha=Math.max(0,this.l); ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
    }
    class FloatingText {
        constructor(x,y,t,c) { this.x=x; this.y=y; this.t=t; this.c=c; this.l=1; this.dy=-1.5; }
        update() { this.y+=this.dy; this.l-=0.02; }
        draw(ctx) { ctx.fillStyle=this.c; ctx.font="bold 24px Arial"; ctx.globalAlpha=Math.max(0,this.l); ctx.shadowColor='black'; ctx.shadowBlur=3; ctx.fillText(this.t,this.x,this.y); ctx.globalAlpha=1; ctx.shadowBlur=0; }
    }

    function startNewQuest() {
        if (Game.bossMode) return;
        Game.quest = generateRandomQuest();
        updateQuestUI();
    }
    function updateQuestProgress(type) {
        if (!Game.quest.active) return;
        let p=false;
        if (Game.quest.type==='collect_items' && type==='item') { Game.quest.current++; p=true; }
        if (Game.quest.type==='get_buff' && type==='buff') { Game.quest.current++; p=true; }
        if (Game.quest.type==='score_points') { Game.quest.current = Game.score - Game.quest.currentScoreStart; p=true; }
        if (Game.quest.type==='dodge_enemies' && type==='enemy_pass') { Game.quest.current++; p=true; }
        if (p) { updateQuestUI(); if (Game.quest.current>=Game.quest.target) completeQuest(); }
    }
    function completeQuest() {
        Game.quest.active=false; Game.score+=Game.quest.reward;
        showBuffMessage(`–ö–í–ï–°–¢ –í–´–ü–û–õ–ù–ï–ù! +${Game.quest.reward}`, '#FFD700');
        updateQuestUI(true); setTimeout(startNewQuest, 3000);
    }
    function updateQuestUI(done=false) {
        const box=document.getElementById('questBox'); const desc=document.getElementById('questDesc'); const bar=document.getElementById('questBar');
        if(done) { desc.textContent="–ó–ê–î–ê–ù–ò–ï –í–´–ü–û–õ–ù–ï–ù–û!"; bar.style.width='100%'; bar.style.backgroundColor='#4CAF50'; return; }
        if(!Game.quest.active) box.classList.add('hidden');
        else { box.classList.remove('hidden'); desc.textContent=Game.quest.text; bar.style.width=Math.min(100,(Game.quest.current/Game.quest.target)*100)+'%'; bar.style.backgroundColor='#FFD700'; }
    }

    function checkLevelUp() {
        const nL = Math.floor(Game.score/100)+1;
        if(nL > Game.level) { Game.level=nL; if(!Game.bossMode) showBuffMessage(`–£–†–û–í–ï–ù–¨ ${nL}!`, '#FFF'); }
    }

    // --- INIT ---
    function startGame() {
        const startToggle = document.getElementById('hardcoreToggle');
        const goToggle = document.getElementById('hardcoreToggleGO');
        const isStartScreenVisible = !document.getElementById('startScreen').classList.contains('hidden');
        
        Game.isHardcore = isStartScreenVisible ? startToggle.checked : goToggle.checked;
        startToggle.checked = Game.isHardcore;
        goToggle.checked = Game.isHardcore;

        Game.maxLives = Game.isHardcore ? 1 : 5; 
        Game.lives = Game.maxLives;
        
        Game.score=0; Game.level=1; Game.gameSpeed=Game.isHardcore?1.2:1.0;
        Game.objects=[]; Game.particles=[]; Game.floatingTexts=[];
        Game.spawnTimer = 0;
        
        Game.player.isSlowed=false; Game.isRunning=true; Game.bossMode=false; Game.boss=null;
        Game.player.x=(Game.width-Game.player.width)/2;
        
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        document.getElementById('bossContainer').style.display='none';
        
        resize(); updateUI(); startNewQuest();
        document.getElementById('bgMusic').play().catch(()=>{});
    }

    function gameOver() {
        Game.isRunning=false;
        document.getElementById('finalScore').textContent=Game.score;
        document.getElementById('gameOverScreen').classList.remove('hidden');
        document.getElementById('hardcoreToggleGO').checked = Game.isHardcore;
    }

    function gameLoop() {
        Game.ctx.clearRect(0,0,Game.width,Game.height);
        if(Game.images.bg.complete) Game.ctx.drawImage(Game.images.bg,0,0,Game.width,Game.height);
        else { Game.ctx.fillStyle='#222'; Game.ctx.fillRect(0,0,Game.width,Game.height); }

        if(Game.isRunning) update();

        if (Game.bossMode && Game.boss) Game.boss.draw(Game.ctx);
        if(Game.images.player.complete) Game.ctx.drawImage(Game.images.player,Game.player.x,Game.player.y,Game.player.width,Game.player.height);
        else { Game.ctx.fillStyle=CONFIG.colors.primary; Game.ctx.fillRect(Game.player.x,Game.player.y,Game.player.width,Game.player.height); }
        
        if (Game.isRunning || !document.getElementById('gameOverScreen').classList.contains('hidden')) {
            Game.objects.forEach(o=>o.draw(Game.ctx));
            Game.particles.forEach(p=>p.draw(Game.ctx));
            Game.floatingTexts.forEach(t=>t.draw(Game.ctx));
        }

        requestAnimationFrame(gameLoop);
    }

    function resize() {
        Game.canvas.width=window.innerWidth; Game.canvas.height=window.innerHeight;
        Game.width=Game.canvas.width; Game.height=Game.canvas.height;
        const isMob=Game.width<=768;
        const pS=isMob?CONFIG.player.mobileSize:CONFIG.player.desktopSize;
        Game.player.width=pS; Game.player.height=pS/CONFIG.player.ratio;
        Game.player.y=Game.height-Game.player.height-20;
    }

    window.addEventListener('load', () => {
        Game.canvas = document.getElementById('gameCanvas');
        Game.ctx = Game.canvas.getContext('2d');
        for (let key in imgSources) { Game.images[key] = new Image(); Game.images[key].src = imgSources[key]; }
        
        window.addEventListener('resize', resize);
        document.addEventListener('keydown', e=>{if(e.code==='ArrowLeft'||e.code==='KeyA')Game.keys.left=true; if(e.code==='ArrowRight'||e.code==='KeyD')Game.keys.right=true;});
        document.addEventListener('keyup', e=>{if(e.code==='ArrowLeft'||e.code==='KeyA')Game.keys.left=false; if(e.code==='ArrowRight'||e.code==='KeyD')Game.keys.right=false;});
        const lZ=document.getElementById('leftZone'); const rZ=document.getElementById('rightZone');
        if(lZ) { lZ.addEventListener('touchstart',e=>{e.preventDefault();Game.keys.left=true;}); lZ.addEventListener('touchend',e=>{e.preventDefault();Game.keys.left=false;}); }
        if(rZ) { rZ.addEventListener('touchstart',e=>{e.preventDefault();Game.keys.right=true;}); rZ.addEventListener('touchend',e=>{e.preventDefault();Game.keys.right=false;}); }
        
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', startGame);
        document.getElementById('muteButton').addEventListener('click', function(){const a=document.getElementById('bgMusic'); if(a.paused){a.play();this.textContent='üîä';}else{a.pause();this.textContent='üîá';}});
        
        resize(); gameLoop();
    });
</script>
</body>
</html>
